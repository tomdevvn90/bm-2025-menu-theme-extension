<script>
  document.addEventListener("DOMContentLoaded", function () {
    var menuMegaClick = document.querySelectorAll('.bm-2025-menu');

    if (menuMegaClick.length > 0) {
      menuMegaClick.forEach(function (menu) {
        menu.addEventListener('click', function (e) { 
          var target = e.target;

          // Click Shop Sub Items (not open)
          if (target.matches('li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__:not(.__mega-menu-open) > a, li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__:not(.__mega-menu-open) > a span')) {
            e.preventDefault();
            document.querySelectorAll('li.__has-children.__menu-item_type____MEGA__, li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__')
              .forEach(function (item) {
                  item.classList.remove('__mega-menu-open');
              });
            target.closest('li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__').classList.add('__mega-menu-open');
            return;
          }

          {% comment %} 
          // Click Shop Sub Items (open)
          if (target.matches('li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__.__mega-menu-open > a, li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__.__mega-menu-open > a span')) {
            e.preventDefault();
            target.closest('li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__').classList.remove('__mega-menu-open');
            return;
          } 
          {% endcomment %}

          // Click Mega Shop Item
          if (target.matches('li.__menu-item_type____MEGASHOP__ > a, li.__menu-item_type____MEGASHOP__ > a span')) {
            e.preventDefault();
            document.querySelectorAll('li.__has-children.__menu-item_type____MEGA__, li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__')
              .forEach(function (item) {
                item.classList.remove('__mega-menu-open');
              });
            document.body.classList.toggle('__mega-shop-menu-open');
            if (document.body.classList.contains('__mega-shop-menu-open')) {
              var firstChild = document.querySelector('li.__menu-item_type____MEGASHOP__ .__type__MEGASHOP__').firstElementChild;
              if (firstChild) {
                firstChild.classList.add('__mega-menu-open');
              }
            }
            return;
          }

          // Click Mega Item (not open)
          if (target.matches('li.__has-children.__menu-item_type____MEGA__:not(.__mega-menu-open) > a, li.__has-children.__menu-item_type____MEGA__:not(.__mega-menu-open) > a span')) {
            e.preventDefault();
            document.body.classList.remove('__mega-shop-menu-open');
            document.querySelectorAll('li.__has-children.__menu-item_type____MEGA__, li.__has-children.__menu-item_type____MEGASHOP_SUBITEM__')
              .forEach(function (item) {
                  item.classList.remove('__mega-menu-open');
              });
            target.closest('li.__has-children.__menu-item_type____MEGA__').classList.add('__mega-menu-open');
            return;
          }

          // Click Mega Item (open)
          if (target.matches('li.__has-children.__menu-item_type____MEGA__.__mega-menu-open > a, li.__has-children.__menu-item_type____MEGA__.__mega-menu-open > a span')) {
            e.preventDefault();
            target.closest('li.__has-children.__menu-item_type____MEGA__').classList.remove('__mega-menu-open');
            return;
          }
        });
      });
    }
  });

  
  {% comment %} const addMenuClickHandle = () => {
    const $menuWrapper = document.querySelector('#__BM_2025_MENU__');
    setInterval(() => {
      let $innerDiv = $menuWrapper.querySelector('.menu-builder-container');
      
      if(!$innerDiv) return;
      if($innerDiv.classList.contains('__addMenuClickHandle')) return;

      let btnToggleMegaShopMenu = document.querySelector('li.__menu-item_type____MEGASHOP__ > a');
      if(!btnToggleMegaShopMenu) return;
      btnToggleMegaShopMenu.addEventListener('click', function(e) {
        e.preventDefault();
        document.body.classList.toggle('__mega-shop-menu-open');
      }); 

      let ulMegaShopMenu = document.querySelector('ul.__type__MEGASHOP__');
      let ulSubMegaShopMenu = document.querySelector('ul.__type__MEGASHOP_SUBITEM__');
      document.documentElement.style.cssText = '--sub-megashop-height: ' + ulMegaShopMenu.offsetHeight + 'px';

      {% comment %} 
      let btnToggleMobiMenu = document.querySelector('.menu-builder-mobi__open');
      btnToggleMobiMenu.addEventListener('click', function(e) {
        e.preventDefault();
        document.body.classList.toggle('__mobi-menu-open');
      });
      let btnCloseMobiMenu = document.querySelector('.menu-builder-mobi__close');
      btnCloseMobiMenu.addEventListener('click', function(e) {
        e.preventDefault();
        document.body.classList.remove('__mobi-menu-open');
      }); {% endcomment %}

      $innerDiv.classList.add('__addMenuClickHandle')
    }, 100);
  }

  document.addEventListener("DOMContentLoaded", function(event){
    addMenuClickHandle();
  }); {% endcomment %}
</script>

<script>
{{ block.settings.custom_js_script }}
</script>

<section class="__menu-builder-container">
  <div class="bm-2025-menu" id="__BM_2025_MENU__" data-store-id="{{ shop.id }}" data-menu-id="{{ block.settings.menu_id }}" >
    {{ block.settings.prerender_html }} 
  </div>
</section>

{% schema %}
{
  "name": "BM Menu Block", 
  "target": "section",
  "javascript": "menu-builder.bundle.js", 
  "stylesheet": "menu-builder.bundle.css", 
  "settings": [ 
    {
      "type": "text", 
      "id": "menu_id",
      "label": "Menu ID",
      "default": "6785dd5184cda285d00b5f60"
    }, 
    {
      "type": "html", 
      "id": "prerender_html",
      "label": "Pre-render HTML"
    },
    {
      "type": "html", 
      "id": "custom_js_script",
      "label": "Custom JS Script"
    }
  ]
} 
{% endschema %}
